<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Cocos2d-Lua手游逆向记录" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Lua5.1" /><meta property="og:description" content="Lua5.1" /><link rel="canonical" href="https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/" /><meta property="og:url" content="https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/" /><meta property="og:site_name" content="Fish." /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-07-24T14:14:20+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Cocos2d-Lua手游逆向记录" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"Cocos2d-Lua手游逆向记录","dateModified":"2024-05-22T17:18:09+08:00","datePublished":"2023-07-24T14:14:20+08:00","description":"Lua5.1","mainEntityOfPage":{"@type":"WebPage","@id":"https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/"},"url":"https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/","@type":"BlogPosting","@context":"https://schema.org"}</script><title>Cocos2d-Lua手游逆向记录 | Fish.</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Fish."><meta name="application-name" content="Fish."><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Fish.</a></div><div class="site-subtitle font-italic">梦虽遥，追则能达。 愿虽艰，持则可圆。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/yuxilong" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['305758560','qq.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Cocos2d-Lua手游逆向记录</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Cocos2d-Lua手游逆向记录</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> yuxilong </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2023-07-24, 14:14 +0800" >2023-07-24<i class="unloaded">2023-07-24T14:14:20+08:00</i> </span></div><div> <span> 更新于 <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2024-05-22, 17:18 +0800" >2024-05-22<i class="unloaded">2024-05-22T17:18:09+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2031 字">11 分钟 阅读</span></div></div><div class="post-content"><h3 id="lua51">Lua5.1</h3><h4 id="lual_loadbuffer">luaL_loadbuffer</h4><h5 id="函数原型">函数原型</h5><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">LUALIB_API</span> <span class="kt">int</span> <span class="nf">luaL_loadbuffer</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
                                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LoadS</span> <span class="n">ls</span><span class="p">;</span>
  <span class="n">ls</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
  <span class="n">ls</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">lua_load</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">getS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ls</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h5 id="特征码">特征码</h5><pre><code class="language-assembly">FF 83 00 D1 FD 7B 01 A9 FD 43 00 91 E1 0B 00 A9 ?? ?? ?? ?? ?? ?? ?? ?? E2 03 00 91 ?? ?? ?? ?? FD
</code></pre><h4 id="luau_undump">luaU_undump</h4><h5 id="函数原型-1">函数原型</h5><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="cm">/*
** load precompiled chunk
*/</span>
<span class="n">Proto</span> <span class="o">*</span><span class="nf">luaU_undump</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="n">ZIO</span> <span class="o">*</span><span class="n">Z</span><span class="p">,</span> <span class="n">Mbuffer</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">LoadState</span> <span class="n">S</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">'@'</span> <span class="o">||</span> <span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">'='</span><span class="p">)</span>
      <span class="n">S</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="n">LUA_SIGNATURE</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">S</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"binary string"</span><span class="p">;</span>
   <span class="k">else</span>
      <span class="n">S</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
   <span class="n">S</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="p">;</span>
   <span class="n">S</span><span class="p">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">;</span>
   <span class="n">S</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
   <span class="n">LoadHeader</span><span class="p">(</span><span class="o">&amp;</span><span class="n">S</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">LoadFunction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">S</span><span class="p">,</span> <span class="n">luaS_newliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"=?"</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><h5 id="特征码-1">特征码</h5><blockquote><p><code class="language-plaintext highlighter-rouge">"binary string"</code>交叉引用</p></blockquote><pre><code class="language-assembly">FF 43 02 D1 F6 57 06 A9 F4 4F 07 A9 FD 7B 08 A9 FD 03 02 91 F5 03 01 AA F3 03 00 AA ?? ?? ?? ?? 08
</code></pre><h4 id="luav_execute">luaV_execute</h4><h5 id="函数原型-2">函数原型</h5><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">luaV_execute</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nexeccalls</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">LClosure</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
  <span class="n">StkId</span> <span class="n">base</span><span class="p">;</span>
  <span class="n">TValue</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">Instruction</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>
 <span class="nl">reentry:</span>  <span class="cm">/* entry point */</span>
  <span class="n">pc</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span><span class="p">;</span>
  <span class="n">cl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clvalue</span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>
  <span class="n">base</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
  <span class="n">k</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">;</span>
  <span class="cm">/* main loop of interpreter */</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">Instruction</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">pc</span><span class="o">++</span><span class="p">;</span>
    <span class="n">StkId</span> <span class="n">ra</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">hookmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LUA_MASKLINE</span> <span class="o">|</span> <span class="n">LUA_MASKCOUNT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="o">--</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">hookcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">hookmask</span> <span class="o">&amp;</span> <span class="n">LUA_MASKLINE</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">traceexec</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">LUA_YIELD</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* did hook yield? */</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">base</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* warning!! several calls may realloc the stack and invalidate `ra' */</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">RA</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">lua_assert</span><span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
    <span class="n">lua_assert</span><span class="p">(</span><span class="n">base</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&amp;&amp;</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">+</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">stacksize</span><span class="p">);</span>
    <span class="n">lua_assert</span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">||</span> <span class="n">luaG_checkopenop</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">GET_OPCODE</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">OP_MOVE</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_LOADK</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">setobj2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">KBx</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_LOADBOOL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">setbvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="n">pc</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* skip next instruction (if C) */</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_LOADNIL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">TValue</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">do</span> <span class="p">{</span>
          <span class="n">setnilvalue</span><span class="p">(</span><span class="n">rb</span><span class="o">--</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rb</span> <span class="o">&gt;=</span> <span class="n">ra</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_GETUPVAL</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">setobj2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">upvals</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_GETGLOBAL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">TValue</span> <span class="n">g</span><span class="p">;</span>
        <span class="n">TValue</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">KBx</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">sethvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">);</span>
        <span class="n">lua_assert</span><span class="p">(</span><span class="n">ttisstring</span><span class="p">(</span><span class="n">rb</span><span class="p">));</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaV_gettable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">ra</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_GETTABLE</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaV_gettable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">RKC</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ra</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_SETGLOBAL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">TValue</span> <span class="n">g</span><span class="p">;</span>
        <span class="n">sethvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">);</span>
        <span class="n">lua_assert</span><span class="p">(</span><span class="n">ttisstring</span><span class="p">(</span><span class="n">KBx</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaV_settable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="n">KBx</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ra</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_SETUPVAL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">UpVal</span> <span class="o">*</span><span class="n">uv</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">upvals</span><span class="p">[</span><span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">)];</span>
        <span class="n">setobj</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">uv</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>
        <span class="n">luaC_barrier</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_SETTABLE</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaV_settable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">RKB</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">RKC</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_NEWTABLE</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">sethvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">luaH_new</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">luaO_fb2int</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">luaO_fb2int</span><span class="p">(</span><span class="n">c</span><span class="p">)));</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaC_checkGC</span><span class="p">(</span><span class="n">L</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_SELF</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">StkId</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaV_gettable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">RKC</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ra</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_ADD</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">arith_op</span><span class="p">(</span><span class="n">luai_numadd</span><span class="p">,</span> <span class="n">TM_ADD</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_SUB</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">arith_op</span><span class="p">(</span><span class="n">luai_numsub</span><span class="p">,</span> <span class="n">TM_SUB</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_MUL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">arith_op</span><span class="p">(</span><span class="n">luai_nummul</span><span class="p">,</span> <span class="n">TM_MUL</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_DIV</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">arith_op</span><span class="p">(</span><span class="n">luai_numdiv</span><span class="p">,</span> <span class="n">TM_DIV</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_MOD</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">arith_op</span><span class="p">(</span><span class="n">luai_nummod</span><span class="p">,</span> <span class="n">TM_MOD</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_POW</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">arith_op</span><span class="p">(</span><span class="n">luai_numpow</span><span class="p">,</span> <span class="n">TM_POW</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_UNM</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">TValue</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ttisnumber</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">lua_Number</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">nvalue</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
          <span class="n">setnvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">luai_numunm</span><span class="p">(</span><span class="n">nb</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="n">Protect</span><span class="p">(</span><span class="n">Arith</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">TM_UNM</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_NOT</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">l_isfalse</span><span class="p">(</span><span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>  <span class="cm">/* next assignment may change this value */</span>
        <span class="n">setbvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_LEN</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">TValue</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">ttype</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">case</span> <span class="n">LUA_TTABLE</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">setnvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">cast_num</span><span class="p">(</span><span class="n">luaH_getn</span><span class="p">(</span><span class="n">hvalue</span><span class="p">(</span><span class="n">rb</span><span class="p">))));</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">case</span> <span class="n">LUA_TSTRING</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">setnvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">cast_num</span><span class="p">(</span><span class="n">tsvalue</span><span class="p">(</span><span class="n">rb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nl">default:</span> <span class="p">{</span>  <span class="cm">/* try metamethod */</span>
            <span class="n">Protect</span><span class="p">(</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call_binTM</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">luaO_nilobject</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">TM_LEN</span><span class="p">))</span>
                <span class="n">luaG_typeerror</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="s">"get length of"</span><span class="p">);</span>
            <span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_CONCAT</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaV_concat</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">c</span><span class="o">-</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span> <span class="n">luaC_checkGC</span><span class="p">(</span><span class="n">L</span><span class="p">));</span>
        <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">RA</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">base</span><span class="o">+</span><span class="n">b</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_JMP</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_EQ</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">TValue</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">RKB</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">TValue</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">RKC</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">Protect</span><span class="p">(</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">equalobj</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span> <span class="o">==</span> <span class="n">GETARG_A</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
        <span class="p">)</span>
        <span class="n">pc</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_LT</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Protect</span><span class="p">(</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">luaV_lessthan</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">RKB</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">RKC</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">GETARG_A</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
        <span class="p">)</span>
        <span class="n">pc</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_LE</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Protect</span><span class="p">(</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">lessequal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">RKB</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">RKC</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">GETARG_A</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
        <span class="p">)</span>
        <span class="n">pc</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_TEST</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l_isfalse</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
          <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
        <span class="n">pc</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_TESTSET</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">TValue</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">RB</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l_isfalse</span><span class="p">(</span><span class="n">rb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>
          <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">pc</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_CALL</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">nresults</span> <span class="o">=</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">ra</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>  <span class="cm">/* else previous instruction set top */</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">luaD_precall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">nresults</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">case</span> <span class="n">PCRLUA</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">nexeccalls</span><span class="o">++</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">reentry</span><span class="p">;</span>  <span class="cm">/* restart luaV_execute over new Lua function */</span>
          <span class="p">}</span>
          <span class="k">case</span> <span class="n">PCRC</span><span class="p">:</span> <span class="p">{</span>
            <span class="cm">/* it was a C function (`precall' called it); adjust results */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nresults</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nl">default:</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>  <span class="cm">/* yield */</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_TAILCALL</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">ra</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>  <span class="cm">/* else previous instruction set top */</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
        <span class="n">lua_assert</span><span class="p">(</span><span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">LUA_MULTRET</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">luaD_precall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">LUA_MULTRET</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">case</span> <span class="n">PCRLUA</span><span class="p">:</span> <span class="p">{</span>
            <span class="cm">/* tail call: put new frame in place of previous one */</span>
            <span class="n">CallInfo</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* previous frame */</span>
            <span class="kt">int</span> <span class="n">aux</span><span class="p">;</span>
            <span class="n">StkId</span> <span class="n">func</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
            <span class="n">StkId</span> <span class="n">pfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ci</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>  <span class="cm">/* previous function index */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">openupval</span><span class="p">)</span> <span class="n">luaF_close</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
            <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">+</span> <span class="p">((</span><span class="n">ci</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">pfunc</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pfunc</span><span class="o">+</span><span class="n">aux</span> <span class="o">&lt;</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span> <span class="n">aux</span><span class="o">++</span><span class="p">)</span>  <span class="cm">/* move frame down */</span>
              <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">func</span><span class="o">+</span><span class="n">aux</span><span class="p">,</span> <span class="n">pfunc</span><span class="o">+</span><span class="n">aux</span><span class="p">);</span>
            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">func</span><span class="o">+</span><span class="n">aux</span><span class="p">;</span>  <span class="cm">/* correct top */</span>
            <span class="n">lua_assert</span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">clvalue</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maxstacksize</span><span class="p">);</span>
            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span><span class="p">;</span>
            <span class="n">ci</span><span class="o">-&gt;</span><span class="n">tailcalls</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* one more call lost */</span>
            <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">--</span><span class="p">;</span>  <span class="cm">/* remove new frame */</span>
            <span class="k">goto</span> <span class="n">reentry</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">case</span> <span class="n">PCRC</span><span class="p">:</span> <span class="p">{</span>  <span class="cm">/* it was a C function (`precall' called it) */</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nl">default:</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>  <span class="cm">/* yield */</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_RETURN</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">ra</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">openupval</span><span class="p">)</span> <span class="n">luaF_close</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">luaD_poscall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">nexeccalls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* was previous function running `here'? */</span>
          <span class="k">return</span><span class="p">;</span>  <span class="cm">/* no: return */</span>
        <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* yes: continue its execution */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
          <span class="n">lua_assert</span><span class="p">(</span><span class="n">isLua</span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">));</span>
          <span class="n">lua_assert</span><span class="p">(</span><span class="n">GET_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">OP_CALL</span><span class="p">);</span>
          <span class="k">goto</span> <span class="n">reentry</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_FORLOOP</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">lua_Number</span> <span class="n">step</span> <span class="o">=</span> <span class="n">nvalue</span><span class="p">(</span><span class="n">ra</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">lua_Number</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">luai_numadd</span><span class="p">(</span><span class="n">nvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">step</span><span class="p">);</span> <span class="cm">/* increment index */</span>
        <span class="n">lua_Number</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">nvalue</span><span class="p">(</span><span class="n">ra</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">luai_numlt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">?</span> <span class="n">luai_numle</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
                                <span class="o">:</span> <span class="n">luai_numle</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>  <span class="cm">/* jump back */</span>
          <span class="n">setnvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>  <span class="cm">/* update internal index... */</span>
          <span class="n">setnvalue</span><span class="p">(</span><span class="n">ra</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>  <span class="cm">/* ...and external index */</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_FORPREP</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">TValue</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
        <span class="k">const</span> <span class="n">TValue</span> <span class="o">*</span><span class="n">plimit</span> <span class="o">=</span> <span class="n">ra</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">const</span> <span class="n">TValue</span> <span class="o">*</span><span class="n">pstep</span> <span class="o">=</span> <span class="n">ra</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">savedpc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>  <span class="cm">/* next steps may throw errors */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tonumber</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">ra</span><span class="p">))</span>
          <span class="n">luaG_runerror</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_QL</span><span class="p">(</span><span class="s">"for"</span><span class="p">)</span> <span class="s">" initial value must be a number"</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tonumber</span><span class="p">(</span><span class="n">plimit</span><span class="p">,</span> <span class="n">ra</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
          <span class="n">luaG_runerror</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_QL</span><span class="p">(</span><span class="s">"for"</span><span class="p">)</span> <span class="s">" limit must be a number"</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tonumber</span><span class="p">(</span><span class="n">pstep</span><span class="p">,</span> <span class="n">ra</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
          <span class="n">luaG_runerror</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_QL</span><span class="p">(</span><span class="s">"for"</span><span class="p">)</span> <span class="s">" step must be a number"</span><span class="p">);</span>
        <span class="n">setnvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">luai_numsub</span><span class="p">(</span><span class="n">nvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">nvalue</span><span class="p">(</span><span class="n">pstep</span><span class="p">)));</span>
        <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_TFORLOOP</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">StkId</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* call base */</span>
        <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cb</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ra</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ra</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">cb</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>  <span class="cm">/* func. + 2 args (state and index) */</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaD_call</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
        <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">RA</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* previous call may change the stack */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ttisnil</span><span class="p">(</span><span class="n">cb</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* continue loop? */</span>
          <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>  <span class="cm">/* save control variable */</span>
          <span class="n">dojump</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">GETARG_sBx</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>  <span class="cm">/* jump back */</span>
        <span class="p">}</span>
        <span class="n">pc</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_SETLIST</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">GETARG_C</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">last</span><span class="p">;</span>
        <span class="n">Table</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">n</span> <span class="o">=</span> <span class="n">cast_int</span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">-</span> <span class="n">ra</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cast_int</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="o">++</span><span class="p">);</span>
        <span class="n">runtime_check</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ttistable</span><span class="p">(</span><span class="n">ra</span><span class="p">));</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hvalue</span><span class="p">(</span><span class="n">ra</span><span class="p">);</span>
        <span class="n">last</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">LFIELDS_PER_FLUSH</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sizearray</span><span class="p">)</span>  <span class="cm">/* needs more space? */</span>
          <span class="n">luaH_resizearray</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>  <span class="cm">/* pre-alloc it at once */</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">TValue</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ra</span><span class="o">+</span><span class="n">n</span><span class="p">;</span>
          <span class="n">setobj2t</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">luaH_setnum</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">last</span><span class="o">--</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
          <span class="n">luaC_barriert</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_CLOSE</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">luaF_close</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_CLOSURE</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">Proto</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
        <span class="n">Closure</span> <span class="o">*</span><span class="n">ncl</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">nup</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">[</span><span class="n">GETARG_Bx</span><span class="p">(</span><span class="n">i</span><span class="p">)];</span>
        <span class="n">nup</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nups</span><span class="p">;</span>
        <span class="n">ncl</span> <span class="o">=</span> <span class="n">luaF_newLclosure</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">nup</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">);</span>
        <span class="n">ncl</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nup</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">pc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">GET_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">)</span> <span class="o">==</span> <span class="n">OP_GETUPVAL</span><span class="p">)</span>
            <span class="n">ncl</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">upvals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">upvals</span><span class="p">[</span><span class="n">GETARG_B</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">)];</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="n">lua_assert</span><span class="p">(</span><span class="n">GET_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">)</span> <span class="o">==</span> <span class="n">OP_MOVE</span><span class="p">);</span>
            <span class="n">ncl</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">upvals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">luaF_findupval</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="o">*</span><span class="n">pc</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">setclvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">ncl</span><span class="p">);</span>
        <span class="n">Protect</span><span class="p">(</span><span class="n">luaC_checkGC</span><span class="p">(</span><span class="n">L</span><span class="p">));</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">OP_VARARG</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GETARG_B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
        <span class="n">CallInfo</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">L</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">cast_int</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="o">-</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">numparams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">LUA_MULTRET</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">Protect</span><span class="p">(</span><span class="n">luaD_checkstack</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
          <span class="n">ra</span> <span class="o">=</span> <span class="n">RA</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>  <span class="cm">/* previous call may change the stack */</span>
          <span class="n">b</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
          <span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">setobjs2s</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ra</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="n">setnilvalue</span><span class="p">(</span><span class="n">ra</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h5 id="特征码-2">特征码</h5><blockquote><p>交叉引用字符串<code class="language-plaintext highlighter-rouge">'for' step must be a number</code></p></blockquote><pre><code class="language-assembly">FF 03 02 D1 FC 6F 02 A9 FA 67 03 A9 F8 5F 04 A9 F6 57 05 A9 F4 4F 06 A9 FD 7B 07 A9 FD C3 01 91 E1 07 ?? ?? F3 03 00 AA 68 EE 42 A9
</code></pre><h4 id="xxtea_decrypt">xxtea_decrypt</h4><h5 id="使用">使用</h5><div class="language-c++ highlighter-rouge"><div class="code-header"> <span text-data=" C++ "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// decrypt XXTEA</span>
<span class="n">xxtea_long</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">xxtea_decrypt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">chunk</span> <span class="o">+</span> <span class="n">_xxteaSignLen</span><span class="p">,</span>
                                      <span class="p">(</span><span class="n">xxtea_long</span><span class="p">)</span><span class="n">chunkSize</span> <span class="o">-</span> <span class="n">_xxteaSignLen</span><span class="p">,</span>
                                      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">_xxteaKey</span><span class="p">,</span>
                                      <span class="p">(</span><span class="n">xxtea_long</span><span class="p">)</span><span class="n">_xxteaKeyLen</span><span class="p">,</span>
                                      <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
</pre></table></code></div></div><h5 id="特征码-3">特征码</h5><pre><code class="language-assembly">FA 67 BB A9 F8 5F 01 A9 F6 57 02 A9 F4 4F 03 A9 FD 7B 04 A9 FD 03 01 91 F3 03 04 AA F7 03 02 AA F4
</code></pre></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/'>逆向记录</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cocos2d-lua/" class="post-tag no-text-decoration" >cocos2d，lua</a> <a href="/tags/%E6%89%8B%E6%B8%B8/" class="post-tag no-text-decoration" >手游</a> <a href="/tags/%E9%80%86%E5%90%91/" class="post-tag no-text-decoration" >逆向</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Cocos2d-Lua手游逆向记录 - Fish.&url=https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cocos2d-Lua手游逆向记录 - Fish.&u=https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Cocos2d-Lua手游逆向记录 - Fish.&url=https://yuxilong.github.io//posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/">Cocos2d-Lua手游逆向记录</a><li><a href="/posts/Frida%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">Frida使用记录</a><li><a href="/posts/macOS%E4%B8%8B%E4%BC%98%E9%9B%85%E6%B3%A8%E5%85%A5%E5%8A%A8%E6%80%81%E5%BA%93/">macOS下优雅注入动态库</a><li><a href="/posts/%E9%9D%9E%E8%B6%8A%E7%8B%B1%E4%B8%8BInlineHook%E6%96%B9%E6%A1%88/">非越狱下InlineHook方案</a><li><a href="/posts/iOS-Development-Tips/">iOS Development Tips</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos%E9%80%86%E5%90%91/">macOS逆向</a> <a class="post-tag" href="/tags/ios%E9%80%86%E5%90%91/">iOS逆向</a> <a class="post-tag" href="/tags/%E9%80%86%E5%90%91/">逆向</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/ios%E5%BC%80%E5%8F%91/">iOS开发</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/cocos2d-lua/">cocos2d，lua</a> <a class="post-tag" href="/tags/dnf/">DNF</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/iOS%E8%B6%8A%E7%8B%B1deb%E6%8F%92%E4%BB%B6%E9%87%8D%E6%89%93%E5%8C%85/"><div class="card-body"> <span class="timeago small" >2024-07-07<i class="unloaded">2024-07-07T14:14:20+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS越狱deb插件重打包</h3><div class="text-muted small"><p> 解压 1 2 3 mkdir package dpkg -x xxx.deb ./package dpkg -e xxx.deb ./package/DEBIAN 压缩 1 dpkg-deb -b ./package xxx_new.deb</p></div></div></a></div><div class="card"> <a href="/posts/iOS%E4%B8%ADFlutter%E5%BA%94%E7%94%A8%E9%80%86%E5%90%91%E6%96%B9%E6%B3%95/"><div class="card-body"> <span class="timeago small" >2024-07-17<i class="unloaded">2024-07-17T16:32:21+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS中Flutter应用逆向方法</h3><div class="text-muted small"><p> 安装reflutter 参考地址：reFlutter 1 pip3 install reflutter 使用 1 2 # 重打包 完成后重签名后安装到iOS设备上即可 reflutter xxx.ipa 使用Charles抓包 Charles监听端口设置为8083即可 查看dump出的dart文件 重签名安装后将iOS设备连接到Mac上，可在macOS的控制台看到...</p></div></div></a></div><div class="card"> <a href="/posts/%E5%AE%89%E5%8D%93%E7%99%BE%E5%BA%A6%E5%8A%A0%E5%9B%BA%E8%84%B1%E5%A3%B3%E8%BF%98%E5%8E%9F%E8%AE%B0%E5%BD%95/"><div class="card-body"> <span class="timeago small" >2024-12-27<i class="unloaded">2024-12-27T11:13:20+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>安卓百度加固脱壳还原记录</h3><div class="text-muted small"><p> 使用的工具 BlackDex MT管理器 jadx 提取安装包 使用BlackDex脱壳 使用`MT管理器对比删除文件 1、删除百度加固文件 assets目录下 lib/arm64-v8a目录下 对比原apk中的dex文件 把脱壳出来的跟原apk中大小一致的删掉 3、使用jdax-ui打开脱壳出来的dex文件 把包含sagittarius包名...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E7%89%B9%E5%BE%81/" class="btn btn-outline-primary" prompt="上一篇"><p>加密算法特征</p></a> <a href="/posts/iOS%E8%B6%8A%E7%8B%B1deb%E6%8F%92%E4%BB%B6%E9%87%8D%E6%89%93%E5%8C%85/" class="btn btn-outline-primary" prompt="下一篇"><p>iOS越狱deb插件重打包</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/username">yuxilong</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/macos%E9%80%86%E5%90%91/">macOS逆向</a> <a class="post-tag" href="/tags/ios%E9%80%86%E5%90%91/">iOS逆向</a> <a class="post-tag" href="/tags/%E9%80%86%E5%90%91/">逆向</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/ios%E5%BC%80%E5%8F%91/">iOS开发</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/cocos2d-lua/">cocos2d，lua</a> <a class="post-tag" href="/tags/dnf/">DNF</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://yuxilong.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
