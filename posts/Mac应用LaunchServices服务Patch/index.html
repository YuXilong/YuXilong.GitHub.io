<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Mac应用LaunchServices服务Patch" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="0x1" /><meta property="og:description" content="0x1" /><link rel="canonical" href="https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/" /><meta property="og:url" content="https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/" /><meta property="og:site_name" content="Fish." /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-04T23:20:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Mac应用LaunchServices服务Patch" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"Mac应用LaunchServices服务Patch","dateModified":"2022-06-04T23:20:00+08:00","datePublished":"2022-06-04T23:20:00+08:00","description":"0x1","mainEntityOfPage":{"@type":"WebPage","@id":"https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/"},"url":"https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/","@type":"BlogPosting","@context":"https://schema.org"}</script><title>Mac应用LaunchServices服务Patch | Fish.</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Fish."><meta name="application-name" content="Fish."><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Fish.</a></div><div class="site-subtitle font-italic">梦虽遥，追则能达。 愿虽艰，持则可圆。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/yuxilong" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['305758560','qq.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Mac应用LaunchServices服务Patch</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Mac应用LaunchServices服务Patch</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> yuxilong </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2022-06-04, 23:20 +0800" >2022-06-04<i class="unloaded">2022-06-04T23:20:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2734 字">15 分钟 阅读</span></div></div><div class="post-content"><h3 id="0x1">0x1</h3><ul><li><p>查看架构</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lipo <span class="nt">-info</span> com.xxxx.Agent
</pre></table></code></div></div><li><p>分离架构</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>lipo com.xxx.Agent <span class="nt">-thin</span> x86_64 <span class="nt">-output</span> com.xxx.Agent_x86_64
lipo com.xxx.Agent <span class="nt">-thin</span> arm64 <span class="nt">-output</span> com.xxx.Agent_arm64
</pre></table></code></div></div></ul><h3 id="0x2">0x2</h3><ul><li>Patch对应架构的LaunchServices</ul><h3 id="0x3">0x3</h3><ul><li>使用010 Editor或者UE打开对应架构的LaunchServices文件<li>查找SMAuthorizedClients字段<li>修改对应的值只留 <strong><em>identifier “com.macpaw.CleanMyMac4.HealthMonitor”</em></strong> 字段<li>记录上一步所删除的值的长度<li>在<strong><em>&lt;/dict&gt;.&lt;/plist&gt;</em></strong>后面插入删除值的长度<li>把新插入的值修改为<strong><em>0A</em></strong><li>保存</ul><h3 id="0x4">0x4</h3><ul><li><p>合并多架构LaunchServices</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lipo <span class="nt">-create</span> com.xxx.Agent_arm64 com.xxx.Agent_x86_64 <span class="nt">-output</span> com.xxxx.Agent
</pre></table></code></div></div><li><p>重签名</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>codesign <span class="nt">-f</span> <span class="nt">-s</span> <span class="s2">"证书"</span> com.xxxx.Agent
</pre></table></code></div></div><li><p>检查LaunchServices签名状态</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>codesign <span class="nt">-v</span> <span class="nt">-v</span> com.xxx.Agent
</pre></table></code></div></div></ul><h3 id="0x5">0x5</h3><ul><li><p>修改主程序的<strong><em>Info.plist</em></strong>的<strong><em>Tools owned after installation</em></strong>字段</p><li><p>重签名主程序</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>codesign <span class="nt">-f</span> <span class="nt">-s</span> <span class="s2">"证书"</span> <span class="nt">--deep</span> <span class="nt">--no-strict</span> xxx.app
</pre></table></code></div></div></ul><h3 id="0x6">0x6</h3><ul><li><p>验证LaunchServices的合法性</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python SMJobBlessUtil.py check xxx.app
</pre></table></code></div></div><li><p><strong><em>SMJobBlessUtil.py</em></strong> 代码</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
</pre><td class="rouge-code"><pre><span class="c1">#! /usr/bin/python3
#
#   File:       SMJobBlessUtil.py
#
#   Contains:   Tool for checking and correcting apps that use SMJobBless.
#
#   Written by: DTS
#
#   Copyright:  Copyright (c) 2012 Apple Inc. All Rights Reserved.
#
#   Disclaimer: IMPORTANT: This Apple software is supplied to you by Apple Inc.
#               ("Apple") in consideration of your agreement to the following
#               terms, and your use, installation, modification or
#               redistribution of this Apple software constitutes acceptance of
#               these terms.  If you do not agree with these terms, please do
#               not use, install, modify or redistribute this Apple software.
#
#               In consideration of your agreement to abide by the following
#               terms, and subject to these terms, Apple grants you a personal,
#               non-exclusive license, under Apple's copyrights in this
#               original Apple software (the "Apple Software"), to use,
#               reproduce, modify and redistribute the Apple Software, with or
#               without modifications, in source and/or binary forms; provided
#               that if you redistribute the Apple Software in its entirety and
#               without modifications, you must retain this notice and the
#               following text and disclaimers in all such redistributions of
#               the Apple Software. Neither the name, trademarks, service marks
#               or logos of Apple Inc. may be used to endorse or promote
#               products derived from the Apple Software without specific prior
#               written permission from Apple.  Except as expressly stated in
#               this notice, no other rights or licenses, express or implied,
#               are granted by Apple herein, including but not limited to any
#               patent rights that may be infringed by your derivative works or
#               by other works in which the Apple Software may be incorporated.
#
#               The Apple Software is provided by Apple on an "AS IS" basis.
#               APPLE MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
#               WITHOUT LIMITATION THE IMPLIED WARRANTIES OF NON-INFRINGEMENT,
#               MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE, REGARDING
#               THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE OR IN
#               COMBINATION WITH YOUR PRODUCTS.
#
#               IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT,
#               INCIDENTAL OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
#               TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#               DATA, OR PROFITS; OR BUSINESS INTERRUPTION) ARISING IN ANY WAY
#               OUT OF THE USE, REPRODUCTION, MODIFICATION AND/OR DISTRIBUTION
#               OF THE APPLE SOFTWARE, HOWEVER CAUSED AND WHETHER UNDER THEORY
#               OF CONTRACT, TORT (INCLUDING NEGLIGENCE), STRICT LIABILITY OR
#               OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE POSSIBILITY OF
#               SUCH DAMAGE.
#
</span>  
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">plistlib</span>
<span class="kn">import</span> <span class="nn">operator</span>
  
  
<span class="k">class</span> <span class="nc">UsageException</span> <span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="s">"""
    Raised when the progam detects a usage issue; the top-level code catches this 
    and prints a usage message.
    """</span>
    <span class="k">pass</span>
  
  
<span class="k">class</span> <span class="nc">CheckException</span> <span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="s">"""
    Raised when the "check" subcommand detects a problem; the top-level code catches 
    this and prints a nice error message.
    """</span>
  
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
  
  
<span class="k">def</span> <span class="nf">checkCodeSignature</span><span class="p">(</span><span class="n">programPath</span><span class="p">,</span> <span class="n">programType</span><span class="p">):</span>
    <span class="s">"""Checks the code signature of the referenced program."""</span>
  
    <span class="c1"># Use the codesign tool to check the signature.  The second "-v" is required to enable
</span>    <span class="c1"># verbose mode, which causes codesign to do more checking.  By default it does the minimum
</span>    <span class="c1"># amount of checking ("Is the program properly signed?").  If you enabled verbose mode it
</span>    <span class="c1"># does other sanity checks, which we definitely want.  The specific thing I'd like to
</span>    <span class="c1"># detect is "Does the code satisfy its own designated requirement?" and I need to enable
</span>    <span class="c1"># verbose mode to get that.
</span>  
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># "false",
</span>        <span class="s">"codesign"</span><span class="p">,</span>
        <span class="s">"-v"</span><span class="p">,</span>
        <span class="s">"-v"</span><span class="p">,</span>
        <span class="n">programPath</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="p">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"%s code signature invalid"</span> <span class="o">%</span>
                             <span class="n">programType</span><span class="p">,</span> <span class="n">programPath</span><span class="p">)</span>
  
  
<span class="k">def</span> <span class="nf">readDesignatedRequirement</span><span class="p">(</span><span class="n">programPath</span><span class="p">,</span> <span class="n">programType</span><span class="p">):</span>
    <span class="s">"""Returns the designated requirement of the program as a string."""</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># "false",
</span>        <span class="s">"codesign"</span><span class="p">,</span>
        <span class="s">"-d"</span><span class="p">,</span>
        <span class="s">"-r"</span><span class="p">,</span>
        <span class="s">"-"</span><span class="p">,</span>
        <span class="n">programPath</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
            <span class="s">"%s designated requirement unreadable"</span> <span class="o">%</span> <span class="n">programType</span><span class="p">,</span> <span class="n">programPath</span><span class="p">)</span>
  
    <span class="n">reqLines</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reqLines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">req</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"designated =&gt; "</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
            <span class="s">"%s designated requirement malformed"</span> <span class="o">%</span> <span class="n">programType</span><span class="p">,</span> <span class="n">programPath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reqLines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="s">"designated =&gt; "</span><span class="p">):]</span>
  
  
<span class="k">def</span> <span class="nf">readInfoPlistFromPath</span><span class="p">(</span><span class="n">infoPath</span><span class="p">):</span>
    <span class="s">"""Reads an "Info.plist" file from the specified path."""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infoPath</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">plistlib</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"'Info.plist' not readable"</span><span class="p">,</span> <span class="n">infoPath</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
            <span class="s">"'Info.plist' root must be a dictionary"</span><span class="p">,</span> <span class="n">infoPath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span>
  
  
<span class="k">def</span> <span class="nf">readPlistFromToolSection</span><span class="p">(</span><span class="n">toolPath</span><span class="p">,</span> <span class="n">segmentName</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">):</span>
    <span class="s">"""Reads a dictionary property list from the specified section within the specified executable."""</span>
  
    <span class="c1"># Run otool -s to get a hex dump of the section.
</span>  
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># "false",
</span>        <span class="s">"otool"</span><span class="p">,</span>
        <span class="s">"-s"</span><span class="p">,</span>
        <span class="n">segmentName</span><span class="p">,</span>
        <span class="n">sectionName</span><span class="p">,</span>
        <span class="n">toolPath</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plistDump</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool %s / %s section unreadable"</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">segmentName</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">),</span> <span class="n">toolPath</span><span class="p">)</span>
  
    <span class="c1"># Convert that hex dump to an property list.
</span>  
    <span class="n">plistLines</span> <span class="o">=</span> <span class="n">plistDump</span><span class="p">.</span><span class="n">splitlines</span><span class="p">()</span>
  
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plistLines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">plistLines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="s">"Contents of (%s,%s) section"</span> <span class="o">%</span> <span class="p">(</span><span class="n">segmentName</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool %s / %s section dump malformed (1)"</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">segmentName</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">),</span> <span class="n">toolPath</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">plistLines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
  
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plistLines</span><span class="p">:</span>
            <span class="c1"># line looks like this:
</span>            <span class="c1">#
</span>            <span class="c1"># '0000000100000b80\t3c 3f 78 6d 6c 20 76 65 72 73 69 6f 6e 3d 22 31 '
</span>            <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">hexStr</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">():</span>
                <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hexStr</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
  
        <span class="n">plist</span> <span class="o">=</span> <span class="n">plistlib</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool %s / %s section dump malformed (2)"</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">segmentName</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">),</span> <span class="n">toolPath</span><span class="p">)</span>
  
    <span class="c1"># Check the root of the property list.
</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool %s / %s property list root must be a dictionary"</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">segmentName</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">),</span> <span class="n">toolPath</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="n">plist</span>
  
  
<span class="k">def</span> <span class="nf">checkStep1</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
    <span class="s">"""Checks that the app and the tool are both correctly code signed."""</span>
  
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"app not found"</span><span class="p">,</span> <span class="n">appPath</span><span class="p">)</span>
  
    <span class="c1"># Check the app's code signature.
</span>  
    <span class="n">checkCodeSignature</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="s">"app"</span><span class="p">)</span>
  
    <span class="c1"># Check the tool directory.
</span>  
    <span class="n">toolDirPath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">appPath</span><span class="p">,</span> <span class="s">"Contents"</span><span class="p">,</span> <span class="s">"Library"</span><span class="p">,</span> <span class="s">"LaunchServices"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">toolDirPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool directory not found"</span><span class="p">,</span> <span class="n">toolDirPath</span><span class="p">)</span>
  
    <span class="c1"># Check each tool's code signature.
</span>  
    <span class="n">toolPathList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">toolName</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">toolDirPath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">toolName</span> <span class="o">!=</span> <span class="s">".DS_Store"</span><span class="p">:</span>
            <span class="n">toolPath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolDirPath</span><span class="p">,</span> <span class="n">toolName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">toolPath</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                    <span class="s">"tool directory contains a directory"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
            <span class="n">checkCodeSignature</span><span class="p">(</span><span class="n">toolPath</span><span class="p">,</span> <span class="s">"tool"</span><span class="p">)</span>
            <span class="n">toolPathList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">toolPath</span><span class="p">)</span>
  
    <span class="c1"># Check that we have at least one tool.
</span>  
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolPathList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"no tools found"</span><span class="p">,</span> <span class="n">toolDirPath</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="n">toolPathList</span>
  
  
<span class="k">def</span> <span class="nf">checkStep2</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">toolPathList</span><span class="p">):</span>
    <span class="s">"""Checks the SMPrivilegedExecutables entry in the app's "Info.plist"."""</span>
  
    <span class="c1"># Create a map from the tool name (not path) to its designated requirement.
</span>  
    <span class="n">toolNameToReqMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">toolPath</span> <span class="ow">in</span> <span class="n">toolPathList</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">readDesignatedRequirement</span><span class="p">(</span><span class="n">toolPath</span><span class="p">,</span> <span class="s">"tool"</span><span class="p">)</span>
        <span class="n">toolNameToReqMap</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">toolPath</span><span class="p">)]</span> <span class="o">=</span> <span class="n">req</span>
  
    <span class="c1"># Read the Info.plist for the app and extract the SMPrivilegedExecutables value.
</span>  
    <span class="n">infoPath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="s">"Contents"</span><span class="p">,</span> <span class="s">"Info.plist"</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">readInfoPlistFromPath</span><span class="p">(</span><span class="n">infoPath</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">"SMPrivilegedExecutables"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"'SMPrivilegedExecutables' not found"</span><span class="p">,</span> <span class="n">infoPath</span><span class="p">)</span>
    <span class="n">infoToolDict</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">"SMPrivilegedExecutables"</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infoToolDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
            <span class="s">"'SMPrivilegedExecutables' must be a dictionary"</span><span class="p">,</span> <span class="n">infoPath</span><span class="p">)</span>
  
    <span class="c1"># Check that the list of tools matches the list of SMPrivilegedExecutables entries.
</span>  
    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">infoToolDict</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">toolNameToReqMap</span><span class="p">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
            <span class="s">"'SMPrivilegedExecutables' and tools in 'Contents/Library/LaunchServices' don't match"</span><span class="p">)</span>
  
    <span class="c1"># Check that all the requirements match.
</span>  
    <span class="c1"># This is an interesting policy choice.  Technically the tool just needs to match
</span>    <span class="c1"># the requirement listed in SMPrivilegedExecutables, and we can check that by
</span>    <span class="c1"># putting the requirement into tmp.req and then running
</span>    <span class="c1">#
</span>    <span class="c1"># $ codesign -v -R tmp.req /path/to/tool
</span>    <span class="c1">#
</span>    <span class="c1"># However, for a Developer ID signed tool we really want to have the SMPrivilegedExecutables
</span>    <span class="c1"># entry contain the tool's designated requirement because Xcode has built a
</span>    <span class="c1"># more complex DR that does lots of useful and important checks.  So, as a matter
</span>    <span class="c1"># of policy we require that the value in SMPrivilegedExecutables match the tool's DR.
</span>  
    <span class="k">for</span> <span class="n">toolName</span> <span class="ow">in</span> <span class="n">infoToolDict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">infoToolDict</span><span class="p">[</span><span class="n">toolName</span><span class="p">]</span> <span class="o">!=</span> <span class="n">toolNameToReqMap</span><span class="p">[</span><span class="n">toolName</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool designated requirement (%s) doesn't match entry in 'SMPrivilegedExecutables' (%s)"</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">toolNameToReqMap</span><span class="p">[</span><span class="n">toolName</span><span class="p">],</span> <span class="n">infoToolDict</span><span class="p">[</span><span class="n">toolName</span><span class="p">]))</span>
  
  
<span class="k">def</span> <span class="nf">checkStep3</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">toolPathList</span><span class="p">):</span>
    <span class="s">"""Checks the "Info.plist" embedded in each helper tool."""</span>
  
    <span class="c1"># First get the app's designated requirement.
</span>  
    <span class="n">appReq</span> <span class="o">=</span> <span class="n">readDesignatedRequirement</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="s">"app"</span><span class="p">)</span>
  
    <span class="c1"># Then check that the tool's SMAuthorizedClients value matches it.
</span>  
    <span class="k">for</span> <span class="n">toolPath</span> <span class="ow">in</span> <span class="n">toolPathList</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">readPlistFromToolSection</span><span class="p">(</span><span class="n">toolPath</span><span class="p">,</span> <span class="s">"__TEXT"</span><span class="p">,</span> <span class="s">"__info_plist"</span><span class="p">)</span>
  
        <span class="k">if</span> <span class="s">"CFBundleInfoDictionaryVersion"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span> <span class="ow">or</span> <span class="n">info</span><span class="p">[</span><span class="s">"CFBundleInfoDictionaryVersion"</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"6.0"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'CFBundleInfoDictionaryVersion' in tool __TEXT / __info_plist section must be '6.0'"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
  
        <span class="k">if</span> <span class="s">"CFBundleIdentifier"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span> <span class="ow">or</span> <span class="n">info</span><span class="p">[</span><span class="s">"CFBundleIdentifier"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">toolPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'CFBundleIdentifier' in tool __TEXT / __info_plist section must match tool name"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
  
        <span class="k">if</span> <span class="s">"SMAuthorizedClients"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'SMAuthorizedClients' in tool __TEXT / __info_plist section not found"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
        <span class="n">infoClientList</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">"SMAuthorizedClients"</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infoClientList</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'SMAuthorizedClients' in tool __TEXT / __info_plist section must be an array"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">infoClientList</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'SMAuthorizedClients' in tool __TEXT / __info_plist section must have one entry"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
  
        <span class="c1"># Again, as a matter of policy we require that the SMAuthorizedClients entry must
</span>        <span class="c1"># match exactly the designated requirement of the app.
</span>  
        <span class="k">if</span> <span class="n">infoClientList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">appReq</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"app designated requirement (%s) doesn't match entry in 'SMAuthorizedClients' (%s)"</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">appReq</span><span class="p">,</span> <span class="n">infoClientList</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">toolPath</span><span class="p">)</span>
  
  
<span class="k">def</span> <span class="nf">checkStep4</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">toolPathList</span><span class="p">):</span>
    <span class="s">"""Checks the "launchd.plist" embedded in each helper tool."""</span>
  
    <span class="k">for</span> <span class="n">toolPath</span> <span class="ow">in</span> <span class="n">toolPathList</span><span class="p">:</span>
        <span class="n">launchd</span> <span class="o">=</span> <span class="n">readPlistFromToolSection</span><span class="p">(</span>
            <span class="n">toolPath</span><span class="p">,</span> <span class="s">"__TEXT"</span><span class="p">,</span> <span class="s">"__launchd_plist"</span><span class="p">)</span>
  
        <span class="k">if</span> <span class="s">"Label"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">launchd</span> <span class="ow">or</span> <span class="n">launchd</span><span class="p">[</span><span class="s">"Label"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">toolPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'Label' in tool __TEXT / __launchd_plist section must match tool name"</span><span class="p">,</span> <span class="n">toolPath</span><span class="p">)</span>
  
        <span class="c1"># We don't need to check that the label matches the bundle identifier because
</span>        <span class="c1"># we know it matches the tool name and step 4 checks that the tool name matches
</span>        <span class="c1"># the bundle identifier.
</span>  
  
<span class="k">def</span> <span class="nf">checkStep5</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
    <span class="s">"""There's nothing to do here; we effectively checked for this is steps 1 and 2."""</span>
    <span class="k">pass</span>
  
  
<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
    <span class="s">"""Checks the SMJobBless setup of the specified app."""</span>
  
    <span class="c1"># Each of the following steps matches a bullet point in the SMJobBless header doc.
</span>  
    <span class="n">toolPathList</span> <span class="o">=</span> <span class="n">checkStep1</span><span class="p">(</span><span class="n">appPath</span><span class="p">)</span>
  
    <span class="n">checkStep2</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">toolPathList</span><span class="p">)</span>
  
    <span class="n">checkStep3</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">toolPathList</span><span class="p">)</span>
  
    <span class="n">checkStep4</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">toolPathList</span><span class="p">)</span>
  
    <span class="n">checkStep5</span><span class="p">(</span><span class="n">appPath</span><span class="p">)</span>
  
  
<span class="k">def</span> <span class="nf">setreq</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">appInfoPlistPath</span><span class="p">,</span> <span class="n">toolInfoPlistPaths</span><span class="p">):</span>
    <span class="s">"""
    Reads information from the built app and uses it to set the SMJobBless setup 
    in the specified app and tool Info.plist source files.
    """</span>
  
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"app not found"</span><span class="p">,</span> <span class="n">appPath</span><span class="p">)</span>
  
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">appInfoPlistPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"app 'Info.plist' not found"</span><span class="p">,</span> <span class="n">appInfoPlistPath</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">toolInfoPlistPath</span> <span class="ow">in</span> <span class="n">toolInfoPlistPaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">toolInfoPlistPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"app 'Info.plist' not found"</span><span class="p">,</span> <span class="n">toolInfoPlistPath</span><span class="p">)</span>
  
    <span class="c1"># Get the designated requirement for the app and each of the tools.
</span>  
    <span class="n">appReq</span> <span class="o">=</span> <span class="n">readDesignatedRequirement</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="s">"app"</span><span class="p">)</span>
  
    <span class="n">toolDirPath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">appPath</span><span class="p">,</span> <span class="s">"Contents"</span><span class="p">,</span> <span class="s">"Library"</span><span class="p">,</span> <span class="s">"LaunchServices"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">toolDirPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool directory not found"</span><span class="p">,</span> <span class="n">toolDirPath</span><span class="p">)</span>
  
    <span class="n">toolNameToReqMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">toolName</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">toolDirPath</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">readDesignatedRequirement</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolDirPath</span><span class="p">,</span> <span class="n">toolName</span><span class="p">),</span> <span class="s">"tool"</span><span class="p">)</span>
        <span class="n">toolNameToReqMap</span><span class="p">[</span><span class="n">toolName</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span>
  
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolNameToReqMap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolInfoPlistPaths</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool directory has more tools (%d) than you've supplied tool 'Info.plist' paths (%d)"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">toolNameToReqMap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolInfoPlistPaths</span><span class="p">)),</span> <span class="n">toolDirPath</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolNameToReqMap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolInfoPlistPaths</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span><span class="s">"tool directory has fewer tools (%d) than you've supplied tool 'Info.plist' paths (%d)"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">toolNameToReqMap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolInfoPlistPaths</span><span class="p">)),</span> <span class="n">toolDirPath</span><span class="p">)</span>
  
    <span class="c1"># Build the new value for SMPrivilegedExecutables.
</span>  
    <span class="n">appToolDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">toolInfoPlistPathToToolInfoMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">toolInfoPlistPath</span> <span class="ow">in</span> <span class="n">toolInfoPlistPaths</span><span class="p">:</span>
        <span class="n">toolInfo</span> <span class="o">=</span> <span class="n">readInfoPlistFromPath</span><span class="p">(</span><span class="n">toolInfoPlistPath</span><span class="p">)</span>
        <span class="n">toolInfoPlistPathToToolInfoMap</span><span class="p">[</span><span class="n">toolInfoPlistPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">toolInfo</span>
        <span class="k">if</span> <span class="s">"CFBundleIdentifier"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toolInfo</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'CFBundleIdentifier' not found"</span><span class="p">,</span> <span class="n">toolInfoPlistPath</span><span class="p">)</span>
        <span class="n">bundleID</span> <span class="o">=</span> <span class="n">toolInfo</span><span class="p">[</span><span class="s">"CFBundleIdentifier"</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bundleID</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'CFBundleIdentifier' must be a string"</span><span class="p">,</span> <span class="n">toolInfoPlistPath</span><span class="p">)</span>
        <span class="n">appToolDict</span><span class="p">[</span><span class="n">bundleID</span><span class="p">]</span> <span class="o">=</span> <span class="n">toolNameToReqMap</span><span class="p">[</span><span class="n">bundleID</span><span class="p">]</span>
  
    <span class="c1"># Set the SMPrivilegedExecutables value in the app "Info.plist".
</span>  
    <span class="n">appInfo</span> <span class="o">=</span> <span class="n">readInfoPlistFromPath</span><span class="p">(</span><span class="n">appInfoPlistPath</span><span class="p">)</span>
    <span class="n">needsUpdate</span> <span class="o">=</span> <span class="s">"SMPrivilegedExecutables"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">appInfo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">needsUpdate</span><span class="p">:</span>
        <span class="n">oldAppToolDict</span> <span class="o">=</span> <span class="n">appInfo</span><span class="p">[</span><span class="s">"SMPrivilegedExecutables"</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldAppToolDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                <span class="s">"'SMPrivilegedExecutables' must be a dictionary"</span><span class="p">,</span> <span class="n">appInfoPlistPath</span><span class="p">)</span>
        <span class="n">appToolDictSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">appToolDict</span><span class="p">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="p">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">oldAppToolDictSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">oldAppToolDict</span><span class="p">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="p">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">needsUpdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">appToolDictSorted</span> <span class="o">!=</span> <span class="n">oldAppToolDictSorted</span><span class="p">)</span>
  
    <span class="k">if</span> <span class="n">needsUpdate</span><span class="p">:</span>
        <span class="n">appInfo</span><span class="p">[</span><span class="s">"SMPrivilegedExecutables"</span><span class="p">]</span> <span class="o">=</span> <span class="n">appToolDict</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">appInfoPlistPath</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">plistlib</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">appInfo</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"%s: updated"</span> <span class="o">%</span> <span class="n">appInfoPlistPath</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
  
    <span class="c1"># Set the SMAuthorizedClients value in each tool's "Info.plist".
</span>  
    <span class="c1"># only one element, so obviously sorted (-:
</span>    <span class="n">toolAppListSorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">appReq</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">toolInfoPlistPath</span> <span class="ow">in</span> <span class="n">toolInfoPlistPaths</span><span class="p">:</span>
        <span class="n">toolInfo</span> <span class="o">=</span> <span class="n">toolInfoPlistPathToToolInfoMap</span><span class="p">[</span><span class="n">toolInfoPlistPath</span><span class="p">]</span>
  
        <span class="n">needsUpdate</span> <span class="o">=</span> <span class="s">"SMAuthorizedClients"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toolInfo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">needsUpdate</span><span class="p">:</span>
            <span class="n">oldToolAppList</span> <span class="o">=</span> <span class="n">toolInfo</span><span class="p">[</span><span class="s">"SMAuthorizedClients"</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldToolAppList</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CheckException</span><span class="p">(</span>
                    <span class="s">"'SMAuthorizedClients' must be an array"</span><span class="p">,</span> <span class="n">toolInfoPlistPath</span><span class="p">)</span>
            <span class="n">oldToolAppListSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">oldToolAppList</span><span class="p">)</span>
            <span class="n">needsUpdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">toolAppListSorted</span> <span class="o">!=</span> <span class="n">oldToolAppListSorted</span><span class="p">)</span>
  
        <span class="k">if</span> <span class="n">needsUpdate</span><span class="p">:</span>
            <span class="n">toolInfo</span><span class="p">[</span><span class="s">"SMAuthorizedClients"</span><span class="p">]</span> <span class="o">=</span> <span class="n">toolAppListSorted</span>
            <span class="n">plistlib</span><span class="p">.</span><span class="n">writePlist</span><span class="p">(</span><span class="n">toolInfo</span><span class="p">,</span> <span class="n">toolInfoPlistPath</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"%s: updated"</span> <span class="o">%</span> <span class="n">toolInfoPlistPath</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
  
  
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">appArgs</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">"d"</span><span class="p">)</span>
  
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">"-d"</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UsageException</span><span class="p">()</span>
  
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">appArgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UsageException</span><span class="p">()</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">appArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"check"</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">appArgs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UsageException</span><span class="p">()</span>
        <span class="n">check</span><span class="p">(</span><span class="n">appArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"setreq"</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">appArgs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UsageException</span><span class="p">()</span>
        <span class="n">setreq</span><span class="p">(</span><span class="n">appArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">appArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">appArgs</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UsageException</span><span class="p">()</span>
  
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">CheckException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"%s: %s"</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">path</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"/"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"%s: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UsageException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"usage: %s check  /path/to/app"</span> <span class="o">%</span>
              <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"       %s setreq /path/to/app /path/to/app/Info.plist /path/to/tool/Info.plist..."</span> <span class="o">%</span>
              <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  
</pre></table></code></div></div></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E9%80%86%E5%90%91%E6%8A%80%E6%9C%AF/'>逆向技术</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/macos%E9%80%86%E5%90%91/" class="post-tag no-text-decoration" >macOS逆向</a> <a href="/tags/ios%E9%80%86%E5%90%91/" class="post-tag no-text-decoration" >iOS逆向</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Mac应用LaunchServices服务Patch - Fish.&url=https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Mac应用LaunchServices服务Patch - Fish.&u=https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Mac应用LaunchServices服务Patch - Fish.&url=https://yuxilong.github.io//posts/Mac%E5%BA%94%E7%94%A8LaunchServices%E6%9C%8D%E5%8A%A1Patch/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Cocos2d-Lua%E6%89%8B%E6%B8%B8%E9%80%86%E5%90%91%E8%AE%B0%E5%BD%95/">Cocos2d-Lua手游逆向记录</a><li><a href="/posts/Frida%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">Frida使用记录</a><li><a href="/posts/macOS%E4%B8%8B%E4%BC%98%E9%9B%85%E6%B3%A8%E5%85%A5%E5%8A%A8%E6%80%81%E5%BA%93/">macOS下优雅注入动态库</a><li><a href="/posts/%E9%9D%9E%E8%B6%8A%E7%8B%B1%E4%B8%8BInlineHook%E6%96%B9%E6%A1%88/">非越狱下InlineHook方案</a><li><a href="/posts/iOS-Development-Tips/">iOS Development Tips</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/macos%E9%80%86%E5%90%91/">macOS逆向</a> <a class="post-tag" href="/tags/ios%E9%80%86%E5%90%91/">iOS逆向</a> <a class="post-tag" href="/tags/%E9%80%86%E5%90%91/">逆向</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/ios%E5%BC%80%E5%8F%91/">iOS开发</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/cocos2d-lua/">cocos2d，lua</a> <a class="post-tag" href="/tags/dnf/">DNF</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/FishHook%E4%BD%BF%E7%94%A8/"><div class="card-body"> <span class="timeago small" >2021-09-03<i class="unloaded">2021-09-03T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FishHook使用</h3><div class="text-muted small"><p> FinshHook使用实例 // 用于存放系统函数原始实现地址 static OSStatus (*orig_SecStaticCodeCheckValidity)(SecCodeRef, SecCSFlags, SecRequirementRef); static OSStatus (*orig_SecStaticCodeCheckValidityWithErrors)(SecStati...</p></div></div></a></div><div class="card"> <a href="/posts/%E9%87%8D%E7%AD%BE%E5%90%8D%E5%91%BD%E4%BB%A4/"><div class="card-body"> <span class="timeago small" >2021-08-27<i class="unloaded">2021-08-27T18:00:20+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>重签名命令汇总</h3><div class="text-muted small"><p> 应用签名 查看应用签名 codesign -d -vv xxx.app 验证应用签名 codesign -vv xxx.app 移除应用签名 codesign --remove-signature xxx.app 应用重签名 获取签名证书 security find-identity -v -p codesigning 重签名 codesign -f -s "证...</p></div></div></a></div><div class="card"> <a href="/posts/Frida%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"><div class="card-body"> <span class="timeago small" >2022-05-31<i class="unloaded">2022-05-31T18:00:20+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Frida使用记录</h3><div class="text-muted small"><p> 启动应用 import frida import sys def on_message(message, data): if message['type'] == 'send': print("[*] {0}".format(message['payload'])) else: print(message) def start_hook(...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E9%87%8D%E7%AD%BE%E5%90%8D%E5%B8%A6%E6%9C%89%E7%89%B9%E6%AE%8A%E6%9D%83%E9%99%90%E7%9A%84%E5%BA%94%E7%94%A8.md/" class="btn btn-outline-primary" prompt="上一篇"><p>重签名带有特殊权限的应用</p></a> <a href="/posts/OLLVM%E6%B7%B7%E6%B7%86%E5%88%9D%E6%8E%A2-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" class="btn btn-outline-primary" prompt="下一篇"><p>OLLVM混淆初探-编译安装</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/username">yuxilong</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/macos%E9%80%86%E5%90%91/">macOS逆向</a> <a class="post-tag" href="/tags/ios%E9%80%86%E5%90%91/">iOS逆向</a> <a class="post-tag" href="/tags/%E9%80%86%E5%90%91/">逆向</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/ios%E5%BC%80%E5%8F%91/">iOS开发</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/cocos2d-lua/">cocos2d，lua</a> <a class="post-tag" href="/tags/dnf/">DNF</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://yuxilong.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
